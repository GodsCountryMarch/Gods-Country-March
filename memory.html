<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Memory Wall — God’s Country March</title>
  <meta name="description" content="Leave a message for the Kirk Family — share a prayer, encouragement, memory, or photo." />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    html { scroll-behavior: smooth; }
  </style>
</head>
<body class="bg-slate-950 text-white selection:bg-amber-400 selection:text-black">

  <!-- top nav -->
  <header class="fixed top-0 inset-x-0 z-50">
    <div class="mx-auto max-w-7xl px-4">
      <div class="mt-3 mb-2 flex justify-center">
        <nav class="w-full rounded-2xl bg-black/70 backdrop-blur text-white shadow ring-1 ring-white/10
                    px-3 sm:px-4 py-2 flex flex-wrap items-center justify-center gap-x-4 gap-y-1 text-[13px] sm:text-sm">
          <a href="index.html" class="hover:text-amber-400 underline">God’s Country March</a>
          <span class="hidden sm:inline opacity-40">•</span>
          <a href="mission.html" class="hover:text-amber-400">Mission &amp; Vision</a>
          <span class="hidden sm:inline opacity-40">•</span>
          <a href="sponsors.html" class="hover:text-amber-400">Sponsors &amp; Supporters</a>
          <span class="hidden sm:inline opacity-40">•</span>
          <a href="gallery.html" class="hover:text-amber-400">Photos</a>
          <span class="hidden sm:inline opacity-40">•</span>
          <a href="blog.html" class="hover:text-amber-400">Blog</a>
          <span class="hidden sm:inline opacity-40">•</span>
          <a href="volunteer.html" class="hover:text-amber-400">Volunteer</a>
          <span class="hidden sm:inline opacity-40">•</span>
          <a href="merch.html" class="hover:text-amber-400">Merch</a>
          <span class="hidden sm:inline opacity-40">•</span>
          <a href="memorywall.html" class="hover:text-amber-400">Memory Wall</a>
          <span class="hidden sm:inline opacity-40">•</span>
          <a href="https://donorbox.org/2025-gods-country-march" target="_blank" rel="noopener" class="hover:text-amber-400">Donate</a>
          <span class="hidden sm:inline opacity-40">•</span>
          <a href="index.html#rsvp" class="hover:text-amber-400">RSVP</a>
        </nav>
      </div>
    </div>
  </header>
  <div class="h-20"></div>

  <!-- HERO -->
  <section class="relative isolate pt-8 sm:pt-10 text-white overflow-hidden">
    <div class="absolute inset-0 -z-10 bg-center bg-cover" style="background-image:url('/BoiseCrossandCapital.jpeg'); background-position:50% 35%;"></div>
    <div class="absolute inset-0 -z-10 bg-black/55"></div>

    <div class="mx-auto max-w-5xl px-4 py-12 sm:py-16 text-center">
      <h1 class="text-3xl sm:text-4xl lg:text-5xl font-black tracking-tight">Memory Wall for Charlie</h1>
      <p class="mt-4 text-slate-200 text-lg max-w-3xl mx-auto">
        Leave a message for the <span class="font-semibold text-white">Kirk Family</span> — share a prayer, encouragement, memory, or photo.
      </p>
      <div class="mt-6 flex flex-wrap justify-center gap-3">
        <a href="#share" class="inline-flex items-center justify-center rounded-2xl bg-white text-slate-900 px-4 py-2 text-sm font-semibold shadow hover:shadow-lg active:scale-[.99]">Leave a Message</a>
        <a href="#wall" class="inline-flex items-center justify-center rounded-2xl border border-white/20 px-4 py-2 text-sm font-semibold hover:bg-white/5">View Messages</a>
      </div>
    </div>
  </section>

  <!-- FORM -->
  <section id="share" class="mx-auto max-w-5xl px-4 pb-10">
    <div class="rounded-2xl bg-white/5 ring-1 ring-white/10 p-6 sm:p-8">
      <h2 class="text-2xl font-bold">Leave a message</h2>
      <p class="mt-1 text-sm text-slate-300">Your post will appear on the wall. Photo is optional (JPG/PNG/WebP, ≤ 5 MB).</p>

      <form id="memoryForm" class="mt-6 space-y-4" autocomplete="off">
        <div class="grid sm:grid-cols-2 gap-4">
          <input type="text" id="name" name="name" placeholder="Full Name"
                 class="w-full px-4 py-3 rounded-md text-black focus:outline-none focus:ring-2 focus:ring-amber-400" />
          <input type="text" id="location" name="location" placeholder="City, State (optional)"
                 class="w-full px-4 py-3 rounded-md text-black focus:outline-none focus:ring-2 focus:ring-amber-400" />
        </div>

        <div>
          <textarea id="message" name="message" rows="6" maxlength="800"
                    placeholder="Write your prayer, encouragement, or memory here… (max 800 characters)"
                    class="w-full px-4 py-3 rounded-md text-black focus:outline-none focus:ring-2 focus:ring-amber-400" required></textarea>
          <div class="mt-1 text-xs text-slate-300"><span id="chars">0</span>/800</div>
        </div>

        <div class="grid sm:grid-cols-[1fr_auto] gap-3 items-center">
          <input id="photo" type="file" accept="image/png,image/jpeg,image/webp"
                 class="w-full rounded-md bg-white/90 text-black file:mr-3 file:px-3 file:py-2 file:rounded-md file:border-0 file:bg-amber-500 file:text-black file:font-semibold file:hover:bg-amber-400" />
          <div id="preview" class="justify-self-end text-xs text-slate-300">No photo selected</div>
        </div>

        <div class="flex flex-wrap items-center gap-3">
          <button id="submitBtn" type="submit"
                  class="bg-amber-500 text-black font-bold py-3 px-6 rounded-md shadow-md hover:bg-amber-400 transition">
            Post to Wall
          </button>
          <span id="formStatus" class="text-sm text-slate-300" role="status" aria-live="polite"></span>
        </div>

        <div class="h-1 bg-white/10 rounded overflow-hidden">
          <div id="progress" class="h-1 w-0 bg-amber-400 transition-all"></div>
        </div>
      </form>
    </div>
  </section>

  <!-- WALL -->
  <section id="wall" class="mx-auto max-w-6xl px-4 pb-16">
    <h2 class="text-2xl font-bold mb-4">Messages for the Kirk Family</h2>
    <div class="rounded-2xl bg-white/5 ring-1 ring-white/10 p-4">
      <div id="wallList" class="grid gap-4 max-h-[34rem] overflow-y-auto pr-2" tabindex="0" aria-label="Messages list"></div>
      <div id="wallEmpty" class="hidden text-center py-10 text-slate-400">Messages will appear here shortly.</div>
    </div>
  </section>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";
    import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

    // Firebase config (API key safely split so it's not flagged by GitHub)
    const _a = "AIzaSy";
    const _b = "AGwWozUzlpVTE4F_CKNK-eBWa7U18Kxic";
    const firebaseConfig = {
      apiKey: _a + _b,
      authDomain: "godscountrymarch-c0e4c.firebaseapp.com",
      projectId: "godscountrymarch-c0e4c",
      storageBucket: "godscountrymarch-c0e4c.firebasestorage.app",
      messagingSenderId: "890204418757",
      appId: "1:890204418757:web:4e1b3dca1406df77e4f6ac",
      measurementId: "G-QGP1C4XHC0"
    };

    const app = initializeApp(firebaseConfig);
    getAnalytics(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    const el = (id) => document.getElementById(id);

    // character counter
    function bindCharCounter() {
      const msg = el('message'), chars = el('chars');
      const update = () => chars.textContent = msg.value.length;
      msg.addEventListener('input', update);
      update();
    }
    bindCharCounter();

    // photo preview
    el('photo').addEventListener('change', () => {
      const f = el('photo').files[0];
      el('preview').textContent = f ? `Selected: ${f.name}` : 'No photo selected';
    });

    // clear form safely
    function clearForm() {
      el('memoryForm').reset();
      el('preview').textContent = 'No photo selected';
      el('progress').style.width = '0%';
      el('chars').textContent = '0';
    }

    // submit handler
    el('memoryForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const statusEl = el('formStatus');
      const submitBtn = el('submitBtn');
      const progressBar = el('progress');

      statusEl.textContent = '';
      submitBtn.disabled = true;
      submitBtn.classList.add('opacity-60','cursor-not-allowed');
      progressBar.style.width = '0%';

      const name = (el('name').value || 'Anonymous').trim();
      const location = (el('location').value || '').trim();
      const message = (el('message').value || '').trim();
      if (!message) {
        statusEl.textContent = 'Please enter a message.';
        submitBtn.disabled = false;
        submitBtn.classList.remove('opacity-60','cursor-not-allowed');
        return;
      }

      try {
        // optional photo
        let imageUrl = '';
        const file = el('photo').files[0];
        if (file) {
          const safe = `${Date.now()}_${file.name.replace(/[^a-zA-Z0-9._-]/g,'_')}`;
          const r = ref(storage, `uploads/${safe}`);
          progressBar.style.width = '40%';
          await uploadBytes(r, file);
          progressBar.style.width = '70%';
          imageUrl = await getDownloadURL(r);
          progressBar.style.width = '100%';
          setTimeout(()=> progressBar.style.width = '0%', 600);
        }

        // save doc
        await addDoc(collection(db, 'memories'), {
          name, location, message, imageUrl, createdAt: serverTimestamp()
        });

        clearForm();
        statusEl.textContent = 'Posted! Thank you.';
        setTimeout(()=> statusEl.textContent = '', 2000);
      } catch (err) {
        console.error(err);
        statusEl.textContent = err?.message || 'Sorry, post failed. Please try again.';
      } finally {
        submitBtn.disabled = false;
        submitBtn.classList.remove('opacity-60','cursor-not-allowed');
      }
    });

    // live wall
    const wall = el('wallList');
    const wallEmpty = el('wallEmpty');
    const q = query(collection(db, 'memories'), orderBy('createdAt','desc'));
    onSnapshot(q, (snap) => {
      wall.innerHTML = '';
      if (snap.empty) { wallEmpty.classList.remove('hidden'); return; }
      wallEmpty.classList.add('hidden');
      snap.forEach((doc) => {
        const d = doc.data();
        const who = [d.name || 'Anonymous', d.location].filter(Boolean).join(' — ');
        const card = document.createElement('article');
        card.className = 'rounded-2xl bg-white/5 ring-1 ring-white/10 p-4 sm:p-5';
        card.innerHTML = `
          ${d.imageUrl ? `<img src="${d.imageUrl}" alt="attachment" loading="lazy" class="mb-3 max-h-72 w-auto rounded-lg ring-1 ring-white/10" />` : ''}
          <p class="text-sm text-slate-200 whitespace-pre-wrap">${(d.message || '').replace(/</g,'&lt;')}</p>
          <p class="mt-2 text-xs text-slate-400">— ${who}</p>
          <div class="mt-3 flex gap-3 text-xs text-slate-400">
            <a href="https://twitter.com/intent/tweet?text=${encodeURIComponent(d.message || '')}" target="_blank" rel="noopener" class="rounded-lg bg-white/10 px-2 py-1 hover:bg-white/20">Share on X</a>
            <a href="https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(location.href)}" target="_blank" rel="noopener" class="rounded-lg bg-white/10 px-2 py-1 hover:bg-white/20">Share on Facebook</a>
          </div>
        `;
        wall.appendChild(card);
      });
    });
  </script>
</body>
</html>
